{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "location": {
            "type": "string",
            "defaultValue": "eastus"
        },
        "workbookName": {
            "type": "string",
            "defaultValue": "Network Operations"
        },
        "workbookGuid": {
            "defaultValue": "[newGuid()]",
            "type": "String"
        },
        "logWorkspaceResourceId": {
            "defaultValue": "/subscriptions/<SUB>/resourceGroups/<RG>/providers/microsoft.operationalinsights/workspaces/<LAWName>",
            "type": "String"
        }
    },
    "variables": {},
    "resources": [
        {
            "type": "microsoft.insights/workbooks",
            "apiVersion": "2020-10-20",
            "name": "[parameters('workbookGuid')]",
            "location": "[parameters('location')]",
            "tags": {
                "hidden-title": "[parameters('workbookName')]"
            },
            "kind": "shared",
            "identity": {
                "type": "None"
            },
            "properties": {
                "displayName": "[parameters('workbookName')]",
                "version": "Notebook/1.0",
                "category": "workbook",
                "sourceId": "[parameters('logWorkspaceResourceId')]",
                "tags": [],
                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"# Azure Network Operations Workbook\"},\"name\":\"text - 2\"},{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"nav\",\"links\":[{\"id\":\"57d5d528-f40f-4610-82ec-841d79387d90\",\"cellValue\":\"https://portal.azure.com/#blade/Microsoft_Azure_Network/NetworkWatcherMenuBlade/overview\",\"linkTarget\":\"Url\",\"linkLabel\":\"Network Watcher\",\"style\":\"link\"},{\"id\":\"f0f98466-269c-457d-b559-22dd80747378\",\"cellValue\":\"https://portal.azure.com/#blade/Microsoft_Azure_Network/NetworkWatcherMenuBlade/vmConnectivity\",\"linkTarget\":\"Url\",\"linkLabel\":\"Connection Troubleshoot\",\"style\":\"link\"},{\"id\":\"61a88ed3-7015-4964-972d-0163b41617be\",\"cellValue\":\"https://portal.azure.com/#blade/HubsExtension/BrowseResourceBlade/resourceType/Microsoft.Network%2FfirewallPolicies\",\"linkTarget\":\"Url\",\"linkLabel\":\"Firewall Policies\",\"style\":\"link\"},{\"id\":\"f56ea403-b849-4b3c-b884-4c5f3f0435ae\",\"cellValue\":\"https://portal.azure.com/#blade/HubsExtension/BrowseResourceBlade/resourceType/Microsoft.Network%2FNetworkSecurityGroups\",\"linkTarget\":\"Url\",\"linkLabel\":\"Network Security Groups (NSG)\",\"style\":\"link\"},{\"id\":\"82335b48-29a8-420e-b0b5-6b272036b929\",\"cellValue\":\"https://portal.azure.com/#blade/Microsoft_Azure_Network/NetworkWatcherMenuBlade/flowLogs\",\"linkTarget\":\"Url\",\"linkLabel\":\"NSG Flow Logs\",\"style\":\"link\"},{\"id\":\"91c2312a-f97d-47ab-b739-f588eac7131a\",\"cellValue\":\"https://portal.azure.com/#blade/HubsExtension/BrowseResource/resourceType/Microsoft.Network%2FvirtualNetworks\",\"linkTarget\":\"Url\",\"linkLabel\":\"Virtual Networks\",\"style\":\"link\"},{\"id\":\"53354c13-b531-46d7-9bcc-408f6e2c2655\",\"cellValue\":\"https://portal.azure.com/#blade/HubsExtension/BrowseResource/resourceType/Microsoft.Network%2FFrontDoorWebApplicationFirewallPolicies\",\"linkTarget\":\"Url\",\"linkLabel\":\"WAF Policies\",\"style\":\"link\"},{\"id\":\"0b85a847-cac3-4c22-b579-29feb9c21373\",\"cellValue\":\"https://portal.azure.com/#blade/HubsExtension/BrowseResourceBlade/resourceType/Microsoft.Network%2FapplicationGateways\",\"linkTarget\":\"Url\",\"linkLabel\":\"Application Gateways\",\"style\":\"link\"}]},\"name\":\"links - 5\"},{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"tabs\",\"links\":[{\"id\":\"865e2077-e775-4361-a193-07387eb73590\",\"cellValue\":\"tabFocus\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Network Rules\",\"subTarget\":\"netRules\",\"preText\":\"\",\"style\":\"link\"},{\"id\":\"cb6fa8d3-85fc-4a5f-84be-14230a860303\",\"cellValue\":\"tabFocus\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Application (URL) Rules\",\"subTarget\":\"appRules\",\"preText\":\"\",\"style\":\"link\"},{\"id\":\"24a3c7e9-268f-46fa-9d24-e80f5b557c01\",\"cellValue\":\"tabFocus\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Application Gateway WAF\",\"subTarget\":\"appGwWAFrules\",\"style\":\"link\"},{\"id\":\"d44b2abf-d5a6-4455-8346-83aae75a8678\",\"cellValue\":\"tabFocus\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Application Gateway\",\"subTarget\":\"appGwRules\",\"style\":\"link\"}]},\"name\":\"links - 6\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"{LogWorkspaces}\"],\"parameters\":[{\"id\":\"0f123d08-9923-42f5-ad95-43ff275a4da3\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"LogWorkspaces\",\"type\":5,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"typeSettings\":{\"resourceTypeFilter\":{\"microsoft.operationalinsights/workspaces\":true},\"additionalResourceOptions\":[\"value::all\"],\"selectAllValue\":\"\",\"showDefault\":false},\"timeContext\":{\"durationMs\":86400000},\"defaultValue\":\"value::all\"},{\"id\":\"96cf90e9-3e7b-4465-8a96-a67441fdcfad\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"type\":4,\"isRequired\":true,\"value\":{\"durationMs\":14400000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":300000},{\"durationMs\":900000},{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}]},\"timeContext\":{\"durationMs\":86400000}}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 3\"},{\"type\":1,\"content\":{\"json\":\"---\"},\"name\":\"text - 7\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"{LogWorkspaces}\"],\"parameters\":[{\"id\":\"4c826b63-e082-46f1-ab1b-8a1a995c4587\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Logs\",\"type\":10,\"isRequired\":true,\"typeSettings\":{\"additionalResourceOptions\":[]},\"jsonData\":\"[ \\r\\n    {\\r\\n        \\\"value\\\": \\\"FirewallLogs, NSGLogs, NSGPubLogs\\\",\\r\\n        \\\"label\\\": \\\"Both\\\",\\r\\n        \\\"selected\\\": true\\r\\n    },\\r\\n    {\\r\\n        \\\"value\\\": \\\"FirewallLogs\\\",\\r\\n        \\\"label\\\": \\\"Firewall\\\",\\r\\n        \\\"selected\\\": false\\r\\n    },\\r\\n    {\\r\\n        \\\"value\\\": \\\"NSGLogs, NSGPubLogs\\\",\\r\\n        \\\"label\\\": \\\"NSGLogs\\\",\\r\\n        \\\"selected\\\": false\\r\\n    }\\r\\n]\",\"timeContext\":{\"durationMs\":14400000},\"timeContextFromParameter\":\"TimeRange\"},{\"id\":\"e11a9518-b034-4285-aa18-f095f606ddca\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Firewalls\",\"type\":5,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"AzureDiagnostics\\r\\n| where ResourceProvider == \\\"MICROSOFT.NETWORK\\\"\\r\\n| where Category == 'AzureFirewallNetworkRule' or Category == \\\"AzureFirewallApplicationRule\\\"\\r\\n| where ResourceId != \\\"\\\"\\r\\n| distinct ResourceId\",\"crossComponentResources\":[\"{LogWorkspaces}\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"selectAllValue\":\"*\",\"showDefault\":false},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"defaultValue\":\"value::all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"value\":[\"value::all\"]},{\"id\":\"da9832dc-0547-484b-b64f-63f6a232f4ac\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"NSGs\",\"type\":5,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"AzureNetworkAnalytics_CL\\r\\n| where NSGList_s != \\\"\\\"\\r\\n| distinct NSGList_s\\r\\n| extend flowsplit = split(NSGList_s, '/')\\r\\n| extend nsgs = strcat('/subscriptions/', flowsplit[0], '/resourcegroups/', flowsplit[1], '/providers/microsoft.network/networksecuritygroups/', flowsplit[2])\\r\\n| project nsgs\",\"crossComponentResources\":[\"{LogWorkspaces}\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"selectAllValue\":\"\",\"showDefault\":false},\"timeContext\":{\"durationMs\":2419200000},\"timeContextFromParameter\":\"TimeRange\",\"defaultValue\":\"value::all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"value\":[\"value::all\"]}],\"style\":\"above\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"tabFocus\",\"comparison\":\"isEqualTo\",\"value\":\"netRules\"},\"name\":\"parameters - 14\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"af68cebc-4ae8-463d-a232-758cb52a2401\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Action_var\",\"label\":\"Firewall Action\",\"type\":10,\"isRequired\":true,\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"jsonData\":\"[\\r\\n    {\\r\\n        \\\"label\\\": \\\"All\\\",\\r\\n        \\\"value\\\": [\\\"Allow'\\\", \\\"'Deny'\\\", \\\"'Inspect'\\\", \\\"'Alert'\\\", \\\"'Drop\\\"],\\r\\n        \\\"selected\\\": true\\r\\n    },\\r\\n    {\\r\\n        \\\"label\\\": \\\"Allow\\\",\\r\\n        \\\"value\\\": \\\"Allow\\\"\\r\\n    },\\r\\n    {\\r\\n        \\\"label\\\": \\\"Deny\\\",\\r\\n        \\\"value\\\": \\\"Deny\\\"\\r\\n    },\\r\\n    {\\r\\n        \\\"label\\\": \\\"Inspect\\\",\\r\\n        \\\"value\\\": \\\"Inspect\\\"\\r\\n    },\\r\\n    {\\r\\n        \\\"label\\\": \\\"Alert\\\",\\r\\n        \\\"value\\\": \\\"Alert\\\"\\r\\n    },\\r\\n    {\\r\\n        \\\"label\\\": \\\"Drop\\\",\\r\\n        \\\"value\\\": \\\"Drop\\\"\\r\\n    }\\r\\n\\r\\n]\"},{\"id\":\"59cd6784-c3c2-4cee-99dd-e1e080f867a3\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"nsg_action\",\"label\":\"NSG Action\",\"type\":10,\"isRequired\":true,\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"jsonData\":\"[\\r\\n\\r\\n{\\r\\n    \\\"label\\\": \\\"All\\\",\\r\\n    \\\"value\\\": [\\\"A'\\\", \\\"'D\\\"],\\r\\n    \\\"selected\\\": true\\r\\n},\\r\\n{\\r\\n    \\\"label\\\": \\\"Allow\\\",\\r\\n    \\\"value\\\": \\\"A\\\"\\r\\n},\\r\\n{\\r\\n    \\\"label\\\": \\\"Deny\\\",\\r\\n    \\\"value\\\": \\\"D\\\"\\r\\n}\\r\\n]\"},{\"id\":\"9bdbaa71-8bdf-460d-8d7e-2d10af5003cd\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"NSGFlowType\",\"label\":\"NSG Flow Type\",\"type\":10,\"isRequired\":true,\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"jsonData\":\"[\\r\\n    {\\r\\n        \\\"label\\\": \\\"All\\\",\\r\\n        \\\"value\\\": [\\\"IntraVNet'\\\", \\\"'InterVNet'\\\", \\\"'AzurePublic'\\\", \\\"'ExternalPublic\\\"],\\r\\n        \\\"selected\\\": true\\r\\n    },\\r\\n    {\\r\\n        \\\"label\\\": \\\"IntraVNet\\\",\\r\\n        \\\"value\\\": \\\"IntraVNet\\\"\\r\\n    },\\r\\n    {\\r\\n        \\\"label\\\": \\\"InterVNet\\\",\\r\\n        \\\"value\\\": \\\"InterVNet\\\"\\r\\n    },\\r\\n    {\\r\\n        \\\"label\\\": \\\"Azure Public\\\",\\r\\n        \\\"value\\\": \\\"AzurePublic\\\"\\r\\n    },\\r\\n    {\\r\\n        \\\"label\\\": \\\"External Public\\\",\\r\\n        \\\"value\\\": \\\"ExternalPublic\\\"\\r\\n    }\\r\\n]\"}],\"style\":\"above\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"tabFocus\",\"comparison\":\"isEqualTo\",\"value\":\"netRules\"},\"name\":\"parameters - 3\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"aa3bcb45-71fa-4493-8d9b-33517bbf2bd0\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Protocol\",\"type\":10,\"isRequired\":true,\"value\":\"All\",\"typeSettings\":{\"additionalResourceOptions\":[]},\"jsonData\":\"[ \\r\\n\\\"All\\\", \\\"TCP\\\", \\\"UDP\\\", \\\"ICMP\\\"\\r\\n]\"},{\"id\":\"6f1e38d6-cbdf-45a2-afb9-d9d9452fc39b\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Source_IP\",\"type\":1,\"timeContext\":{\"durationMs\":86400000},\"value\":\"\"},{\"id\":\"0123b1b2-4569-496b-9ab7-7c844b004ca9\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Destination_IP\",\"type\":1,\"timeContext\":{\"durationMs\":86400000},\"value\":\"\"},{\"id\":\"b2cd6b69-0f58-4e60-b340-29ff9a947761\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Destination_Port\",\"type\":1,\"value\":\"\",\"timeContext\":{\"durationMs\":86400000}}],\"style\":\"above\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"tabFocus\",\"comparison\":\"isEqualTo\",\"value\":\"netRules\"},\"name\":\"parameters - 4\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let NSGParamSearch = datatable(nsgid:string)[{NSGs}];\\nlet NSGSearch = NSGParamSearch\\n| extend nsgSplit = split(nsgid, '/')\\n| extend nsgFlow = strcat(nsgSplit[2], '/', nsgSplit[4], '/', nsgSplit[8])\\n| project nsgFlow;\\n// Start AZFWSearch\\nlet FirewallLogs = AzureDiagnostics\\n| where Category == \\\"AzureFirewallNetworkRule\\\"\\n| where ResourceId has_any({Firewalls}) or ResourceId != {Firewalls}\\n| where OperationName <> \\\"AzureFirewallThreatIntelLog\\\"\\n| parse msg_s with Protocol \\\" request from\\\" SourceIP \\\":\\\" SourcePortInt: int \\\" to\\\" TargetIP \\\":\\\" TargetPortInt: int *\\n| parse msg_s with * \\\". Action: \\\" Action1a\\n| parse msg_s with * \\\" was \\\" Action1b \\\" to \\\" NatDestination\\n| parse msg_s with Protocol2 \\\" request from\\\" SourceIP2 \\\" to\\\" TargetIP2 \\\". Action:\\\" Action2\\n| parse msg_s with Protocol_s 'request from ' SourceHost_s ':' SourcePort_s 'to ' DestinationHost_s ':' DestinationPort_s 'was' Action_s 'to' DNATDestination\\n| parse msg_s with Protocol_S 'request from ' SourceHost_S ':' SourcePort_S 'to ' DestinationHost_S ':' DestinationPort_S '. Action:' Action_S\\n| extend Protocol = strcat(Protocol_s, Protocol_S), SourceHost = strcat(SourceHost_s, SourceHost_S), SourcePort = strcat(SourcePort_s, SourcePort_S), DestinationHost = strcat(DestinationHost_s, DestinationHost_S), DestinationPort = strcat(DestinationPort_s, DestinationPort_S), Action = strcat(Action_s, Action_S)\\n| extend SourcePort = tostring(SourcePortInt), TargetPort = tostring(TargetPortInt)\\n| extend Action = case(Action1a == \\\"\\\", case(Action1b == \\\"\\\", Action2, Action1b), Action1a), Protocol = case(Protocol == \\\"\\\", Protocol2, Protocol), SourceIP = case(SourceIP == \\\"\\\", SourceIP2, SourceIP), TargetIP = case(TargetIP == \\\"\\\", TargetIP2, TargetIP), SourcePort = case(SourcePort == \\\"\\\", \\\"N/A\\\", SourcePort), TargetPort = case(TargetPort == \\\"\\\", \\\"N/A\\\", TargetPort), NatDestination = case(NatDestination == \\\"\\\", \\\"N/A\\\", NatDestination)\\n| where '*' == TargetPort or '*' == \\\"*\\\"\\n| where \\\"*\\\" == Action or \\\"*\\\" == \\\"*\\\"\\n| where '*' == NatDestination or '*' == \\\"*\\\"\\n| where SourceHost contains '{Source_IP}'\\n| where DestinationHost contains '{Destination_IP}'\\n| where DestinationPort startswith '{Destination_Port}'\\n| where Action has_any ('{Action_var}')\\n| extend Protocol_var = case('{Protocol}' == \\\"TCP\\\", \\\"TCP\\\", '{Protocol}' == \\\"UDP\\\", \\\"UDP\\\", '{Protocol}' == \\\"All\\\", \\\"\\\", '{Protocol}' == \\\"ICMP\\\", \\\"ICMP\\\", \\\"\\\")\\n| where Protocol contains Protocol_var\\n| project TimeGenerated, Protocol, Action, SourceHost, DestinationHost, DestinationPort, ResourceId;\\n// -------- Private IP NSG Logs\\n/// ----------------------------------------------------------------------\\nlet NSGLogs = AzureNetworkAnalytics_CL\\n| where NSGList_s has_any(NSGSearch)\\n| extend SourceHost=SrcIP_s\\n| extend DestinationHost=DestIP_s\\n| extend NSGRuleAction =tostring(split(NSGRules_s, '|', 3)[0])\\n| extend NSGRuleName=tostring(split(NSGRules_s, '|', 1)[0])\\n| extend NSGName=tostring(split(NSGList_s, '/', 2)[0])\\n| where \\\"'D','A'\\\" has NSGRuleAction\\n| where DestinationHost has \\\"\\\"\\n| where FlowType_s has_any('{NSGFlowType}')\\n| extend Protocol = case(L4Protocol_s == \\\"T\\\", \\\"TCP\\\", L4Protocol_s  == \\\"U\\\", \\\"UDP\\\", \\\"\\\")\\n| extend Protocol_var = case('{Protocol}' == \\\"TCP\\\", \\\"T\\\", '{Protocol}' == \\\"UDP\\\", \\\"U\\\", '{Protocol}' == \\\"All\\\", \\\"\\\", '{Protocol}' == \\\"ICMP\\\", \\\"None\\\", \\\"\\\"  )\\n| extend Action = case(NSGRuleAction == \\\"D\\\", \\\"Deny\\\",  NSGRuleAction == \\\"A\\\", \\\"Allow\\\", \\\"\\\")\\n| extend DestinationPort = split(tostring(DestPort_d), \\\".\\\")[0]\\n| extend ResourceId = split(NSGList_s, \\\"/\\\")\\n| extend ResourceId = strcat(\\\"/subscriptions/\\\", ResourceId[0], \\\"/resourceGroups/\\\", ResourceId[1], \\\"/providers/Microsoft.Network/networkSecurityGroups/\\\", ResourceId[2])\\n| where SourceHost contains '{Source_IP}'\\n| where DestinationHost contains '{Destination_IP}'\\n| where DestinationHost != ''\\n| where DestinationPort startswith '{Destination_Port}'\\n| where NSGRuleAction has_any ('{nsg_action}')\\n| where L4Protocol_s contains Protocol_var\\n| project TimeGenerated, Protocol, Action, SourceHost, DestinationHost, tostring(DestinationPort), ResourceId;\\n// -------- Public IP NSG Logs \\n/// ----------------------------------------------------------------------\\nlet NSGPubLogs = AzureNetworkAnalytics_CL\\n| where NSGList_s has_any(NSGSearch)\\n| extend SourceHost=SrcIP_s\\n| extend DestinationHost=DestIP_s\\n| extend NSGRuleAction =tostring(split(NSGRules_s, '|', 3)[0])\\n| extend NSGRuleName=tostring(split(NSGRules_s, '|', 1)[0])\\n| extend NSGName=tostring(split(NSGList_s, '/', 2)[0])\\n| where \\\"'D','A'\\\" has NSGRuleAction\\n| where DestinationHost has \\\"\\\"\\n| where FlowType_s has_any('{NSGFlowType}')\\n| extend Protocol = case(L4Protocol_s == \\\"T\\\", \\\"TCP\\\", L4Protocol_s  == \\\"U\\\", \\\"UDP\\\", \\\"\\\")\\n| extend Protocol_var = case('{Protocol}' == \\\"TCP\\\", \\\"T\\\", '{Protocol}' == \\\"UDP\\\", \\\"U\\\", '{Protocol}' == \\\"All\\\", \\\"\\\", '{Protocol}' == \\\"ICMP\\\", \\\"None\\\", \\\"\\\"  )\\n| extend Action = case(NSGRuleAction == \\\"D\\\", \\\"Deny\\\",  NSGRuleAction == \\\"A\\\", \\\"Allow\\\", \\\"\\\")\\n| extend DestinationPort = split(tostring(DestPort_d), \\\".\\\")[0]\\n| extend ResourceId = split(NSGList_s, \\\"/\\\")\\n| extend ResourceId = strcat(\\\"/subscriptions/\\\", ResourceId[0], \\\"/resourceGroups/\\\", ResourceId[1], \\\"/providers/Microsoft.Network/networkSecurityGroups/\\\", ResourceId[2])\\n| where SourceHost contains '{Source_IP}'\\n| where DestinationPort startswith '{Destination_Port}'\\n| where NSGRuleAction has_any ('{nsg_action}')\\n| where L4Protocol_s contains Protocol_var\\n| extend PublicIP = split(DestPublicIPs_s, '|')\\n| mv-expand PublicIP\\n| where PublicIP has '.'\\n| extend PublicIP = trim(@\\\"\\\\d+ \\\", tostring(PublicIP))\\n| extend DestinationHost = case(DestinationHost == '', PublicIP, DestinationHost)\\n| where DestinationHost contains '{Destination_IP}'\\n| project TimeGenerated, Protocol, Action, SourceHost, DestinationHost, tostring(DestinationPort), ResourceId;\\n/// Combine Firewall and NSG Logs\\n/// ----------------------------------------------------------------------\\nunion {Logs}\\n| summarize by TimeGenerated, Protocol, Action, SourceHost, DestinationHost, tostring(DestinationPort), ResourceId\\n| sort by TimeGenerated\",\"size\":0,\"noDataMessageStyle\":5,\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"showRefreshButton\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{LogWorkspaces}\"],\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Action\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"==\",\"thresholdValue\":\"Allow\",\"representation\":\"success\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Deny\",\"representation\":\"disabled\",\"text\":\"{0}{1}\"},{\"operator\":\"==\",\"thresholdValue\":\"Inspect\",\"representation\":\"info\",\"text\":\"{0}{1}\"},{\"operator\":\"startsWith\",\"thresholdValue\":\"drop\",\"representation\":\"disabled\",\"text\":\"{0}{1}\"},{\"operator\":\"startsWith\",\"thresholdValue\":\"alert\",\"representation\":\"warning\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"more\",\"text\":\"{0}{1}\"}]}}],\"sortBy\":[{\"itemKey\":\"SourceHost\",\"sortOrder\":1}]},\"sortBy\":[{\"itemKey\":\"SourceHost\",\"sortOrder\":1}]},\"conditionalVisibility\":{\"parameterName\":\"tabFocus\",\"comparison\":\"isEqualTo\",\"value\":\"netRules\"},\"name\":\"Firewall Deny\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"fcaaf5dc-3757-40f7-8399-1761e08a7a7d\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"app_Action\",\"label\":\"Action\",\"type\":10,\"isRequired\":true,\"value\":\"Allow\",\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"jsonData\":\"[\\\"Allow\\\", \\\"Deny\\\"]\",\"timeContext\":{\"durationMs\":86400000}}],\"style\":\"above\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"tabFocus\",\"comparison\":\"isEqualTo\",\"value\":\"appRules\"},\"name\":\"parameters - 12\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"f56e1291-1197-4af1-995d-c53c5b415584\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"app_source_ip\",\"label\":\"Source_IP\",\"type\":1,\"timeContext\":{\"durationMs\":86400000}},{\"id\":\"f1c43039-1532-47cb-823f-6fe6d18e8a1f\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Destination_Host\",\"type\":1,\"value\":\"\",\"timeContext\":{\"durationMs\":86400000}},{\"version\":\"KqlParameterItem/1.0\",\"name\":\"Destination_URL\",\"type\":1,\"value\":\"\",\"timeContext\":{\"durationMs\":86400000},\"id\":\"a9c6e639-c793-42a9-849d-804d6c3574ad\"}],\"style\":\"above\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"tabFocus\",\"comparison\":\"isEqualTo\",\"value\":\"appRules\"},\"name\":\"parameters - 10\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"AzureDiagnostics \\n| where Category == \\\"AzureFirewallApplicationRule\\\"\\n| where ResourceId has_any({Firewalls}) or ResourceId != {Firewalls}\\n| parse msg_s with Protocol \\\" request from \\\" SourceIP \\\":\\\" SourcePortInt: int \\\" \\\" TempDetails \\n| parse TempDetails with \\\"was \\\" Action1 \\\". Reason: \\\" Rule1 \\n| parse TempDetails with \\\"to \\\" FQDN \\\":\\\" TargetPortInt: int \\\". Action: \\\" Action2 \\\".\\\" * \\n| parse TempDetails with * \\\". Rule Collection: \\\" RuleCollection2a \\\". Rule:\\\" Rule2a \\n| parse TempDetails with * \\\"Deny.\\\" RuleCollection2b \\\". Proceeding with\\\" Rule2b\\n| parse msg_s with Protocol_s 'request from ' SourceHost_s ':' SourcePort_s 'to ' DestinationHost_s ':' DestinationPort_s 'was' Action_s 'to' DNATDestination\\n| parse msg_s with Protocol_S 'request from ' SourceHost_S ':' SourcePort_S 'to ' DestinationHost_S ':' DestinationPort_S '. Action:' Action_S\\n| extend Protocol = strcat(Protocol_s, Protocol_S), SourceHost = strcat(SourceHost_s, SourceHost_S), SourcePort = strcat(SourcePort_s, SourcePort_S), DestinationHost = strcat(DestinationHost_s, DestinationHost_S), DestinationPort = strcat(DestinationPort_s, DestinationPort_S), Action = strcat(Action_s, Action_S)\\n| extend SourcePort = tostring(SourcePortInt) \\n| extend TargetPort = tostring(TargetPortInt)\\n| extend Action1 = case(Action1 == \\\"denied\\\", \\\"Deny\\\", \\\"Unknown Action\\\") \\n| extend Action = case(Action2 == \\\"\\\", Action1, Action2), Rule = case(Rule2a == \\\"\\\", case(Rule1 == \\\"\\\", case(Rule2b == \\\"\\\", \\\" default action\\\", Rule2b), Rule1), Rule2a), RuleCollection = case(RuleCollection2b == \\\"\\\", case(RuleCollection2a == \\\"\\\", \\\"No rule matched\\\", RuleCollection2a), RuleCollection2b), FQDN = case(FQDN == \\\"\\\", \\\" default action\\\", FQDN), TargetPort = case(TargetPort == \\\"\\\", \\\" default action\\\", TargetPort)\\n| where '*' == SourceIP or '*' == \\\"*\\\" \\n| parse Rule with WebAllow \\\" Web Categories. Web Category:\\\" WebCat\\n| extend WebCategory = case(WebCat == \\\"\\\", \\\"N/A\\\", WebCat)\\n| extend MyAction = case(Action == \\\"Deny\\\", case(Action == \\\"Allow\\\", case(WebAllow == \\\"Allowed\\\", case(WebAllow == \\\"\\\", \\\"Deny\\\", \\\"Unknown\\\"), Action), Action), \\\"Allow\\\")\\n| extend Action = MyAction\\n| parse DestinationPort with webPort \\\". Url: \\\" URL\\n| extend myPort = case(webPort == \\\"\\\", TargetPort, webPort)\\n| extend DestinationPort = myPort\\n| where Action startswith '{app_Action}'\\n| where SourceHost contains '{app_source_ip}'\\n| where DestinationHost contains '{Destination_Host}'\\n| where URL contains '{Destination_URL}'\\n| summarize by TimeGenerated, Protocol, Action, SourceHost, DestinationHost, DestinationPort, URL, Rule, ResourceId\\n| sort by TimeGenerated\",\"size\":0,\"noDataMessageStyle\":5,\"timeContext\":{\"durationMs\":86400000},\"timeContextFromParameter\":\"TimeRange\",\"showRefreshButton\":true,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{LogWorkspaces}\"]},\"conditionalVisibility\":{\"parameterName\":\"tabFocus\",\"comparison\":\"isEqualTo\",\"value\":\"appRules\"},\"name\":\"Firewall Deny - Copy\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"crossComponentResources\":[\"{LogWorkspaces}\"],\"parameters\":[{\"id\":\"3db7bc43-10ab-4b1d-a224-532f3c45a387\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"appgw_Source\",\"label\":\"SourceIp\",\"type\":1,\"timeContext\":{\"durationMs\":86400000},\"value\":\"\"},{\"id\":\"6961d748-fb79-4c1b-a4fd-eb981aa62050\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Path\",\"type\":1,\"timeContext\":{\"durationMs\":86400000},\"value\":\"\"},{\"id\":\"efa5b3ee-db73-4578-812f-82cd0b5b1053\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Message\",\"type\":1,\"value\":\"\",\"timeContext\":{\"durationMs\":86400000},\"label\":\"Message / Request\"},{\"id\":\"d422437f-b2c4-4db1-aa89-165bfb70e498\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"App_GW\",\"label\":\"Application Gateway\",\"type\":5,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"AzureDiagnostics\\r\\n| where ResourceProvider == \\\"MICROSOFT.NETWORK\\\" and Category == \\\"ApplicationGatewayFirewallLog\\\" or Category == \\\"ApplicationGatewayAccessLog\\\"\\r\\n| distinct ResourceId\",\"crossComponentResources\":[\"{LogWorkspaces}\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"timeContext\":{\"durationMs\":86400000},\"defaultValue\":\"value::all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"}],\"style\":\"above\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibilities\":[{\"parameterName\":\"tabFocus\",\"comparison\":\"isNotEqualTo\",\"value\":\"netRules\"},{\"parameterName\":\"tabFocus\",\"comparison\":\"isNotEqualTo\",\"value\":\"appRules\"}],\"name\":\"parameters - 12\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"AzureDiagnostics\\r\\n| where ResourceProvider == \\\"MICROSOFT.NETWORK\\\" and Category == \\\"ApplicationGatewayFirewallLog\\\"\\r\\n| extend SourceIp = clientIp_s\\r\\n| extend Path = requestUri_s\\r\\n| extend Policy = policyId_s\\r\\n| extend RuleType = ruleSetType_s\\r\\n| where clientIp_s startswith '{appgw_Source}'\\r\\n| where requestUri_s contains '{Path}'\\r\\n| where Message contains '{Message}'\\r\\n| where ResourceId has_any({App_GW})\\r\\n| project TimeGenerated, Policy, RuleType, Message, Path, SourceIp, ResourceId\",\"size\":0,\"timeContext\":{\"durationMs\":86400000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{LogWorkspaces}\"]},\"conditionalVisibility\":{\"parameterName\":\"tabFocus\",\"comparison\":\"isEqualTo\",\"value\":\"appGwWAFrules\"},\"name\":\"query - 11\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"AzureDiagnostics | where ResourceProvider == \\\"MICROSOFT.NETWORK\\\" and Category == \\\"ApplicationGatewayAccessLog\\\"\\r\\n| extend SourceIp = clientIP_s\\r\\n| extend Path = requestUri_s\\r\\n| extend Rule = ruleName_s\\r\\n| extend Method = httpMethod_s\\r\\n| extend Request = requestQuery_s\\r\\n| extend Status = httpStatus_d\\r\\n| where clientIP_s startswith '{appgw_Source}'\\r\\n| where requestUri_s contains '{Path}'\\r\\n| where requestQuery_s contains '{Message}'\\r\\n| where ResourceId has_any({App_GW})\\r\\n| project TimeGenerated, Rule, Method, Status, Path, Request, SourceIp, ResourceId\",\"size\":0,\"timeContext\":{\"durationMs\":86400000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"crossComponentResources\":[\"{LogWorkspaces}\"]},\"conditionalVisibility\":{\"parameterName\":\"tabFocus\",\"comparison\":\"isEqualTo\",\"value\":\"appGwRules\"},\"name\":\"query - 13\"}],\"isLocked\":true,\"fallbackResourceIds\":[\"/subscriptions\"]}"
            }
        }
    ]
}